\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chapter-format-formalbar}[2014/10/23 Title chapter package]


\RequirePackage{xcolor}
\RequirePackage{kvoptions} % Carga la biblioteca kvoptions
\RequirePackage[explicit]{titlesec} % necesario para titleformat. [explicit] habilita usar #1
\RequirePackage[most]{tcolorbox}
\RequirePackage{tikz}
\RequirePackage{lmodern}% The lmodern package was used just to have access to a 80pt font size.


\makeatletter

% Define las opciones de paquete Width y TextColor
\SetupKeyvalOptions{
  family=ChapterFormatFormalBar,
  prefix=ChapterFormatFormalBar@
}


\DeclareStringOption[black]{BanerColor}
\DeclareStringOption[0.6cm]{BanerInner}
\DeclareStringOption[black]{TitleColor}
\DeclareStringOption[30]{TitleFontsize}
\DeclareStringOption[black]{PreTitleColor}
\DeclareStringOption[16]{PreTitleFontsize}
\DeclareStringOption[30]{PreTitleNumberFontsize}
\DeclareStringOption[white]{PreTitleNumberColor}
\DeclareStringOption[black]{PreTitleNumberBackgroundColor}
\DeclareStringOption[1.7cm]{PreTitleNumberWidth}
\DeclareStringOption[1.7cm]{PreTitleNumberHeight}
\DeclareStringOption[0.4cm]{PreTitleNumberYOffset}




% Procesa las opciones del paquete
\ProcessKeyvalOptions*


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title with number
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries}
  {}
  {20pt}
  {%
    \begin{tcolorbox}[
      enhanced,
      colback=\ChapterFormatFormalBar@BanerColor,%colorChapter,
      boxrule=0pt,%0.25cm,
      colframe=\ChapterFormatFormalBar@BanerColor,%colorChapter!3,
      arc=0pt,
      outer arc=0pt,
      leftrule=0pt,
      rightrule=0pt,
      fontupper=\color{\ChapterFormatFormalBar@TitleColor}\bfseries\fontsize{\ChapterFormatFormalBar@TitleFontsize}{16pt}\selectfont,
      enlarge left by=-1in-\hoffset-\oddsidemargin, 
      enlarge right by=-\paperwidth+1in+\hoffset+\oddsidemargin+\textwidth,
      width=\paperwidth, 
      left=1in+\hoffset+\oddsidemargin, 
      right=\paperwidth-1in-\hoffset-\oddsidemargin-\textwidth,
      top=\ChapterFormatFormalBar@BanerInner, 
      bottom=\ChapterFormatFormalBar@BanerInner,
      overlay={
        %
        \node[
          fill=\ChapterFormatFormalBar@PreTitleNumberBackgroundColor,
          draw=white,
          line width=0.15cm,
          inner sep=0pt,
          text width=\ChapterFormatFormalBar@PreTitleNumberWidth,
          minimum height=\ChapterFormatFormalBar@PreTitleNumberWidth,
          align=center,
          font=\color{\ChapterFormatFormalBar@PreTitleNumberColor}\sffamily\bfseries\fontsize{\ChapterFormatFormalBar@PreTitleNumberFontsize}{16pt}\selectfont
        ] 
        (chapname)
        at ([xshift=-4cm,yshift=\ChapterFormatFormalBar@PreTitleNumberYOffset]frame.north east)
        {\thechapter};
        %
        \node[
            font=\fontsize{\ChapterFormatFormalBar@PreTitleFontsize}{16pt}\selectfont\color{\ChapterFormatFormalBar@PreTitleColor},
            anchor=south,
            inner sep=2pt
        ] at (chapname.north)
        {\MakeUppercase\chaptertitlename}; %%\chaptertitlename=CAP√çTULO % if using amsbook, this should be \chaptername
      } 
    ]
    #1
    \end{tcolorbox}%
  }
  [\vspace{-25pt}]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title without number
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\titleformat{name=\chapter,numberless}[display]
  {\normalfont\huge\bfseries}
  {}
  {20pt}
  {%
    \begin{tcolorbox}[
      enhanced,
      colback=\ChapterFormatFormalBar@BanerColor,
      boxrule=0pt,%0.25cm,
      colframe=\ChapterFormatFormalBar@BanerColor,
      arc=0pt,
      outer arc=0pt,
      remember as=title,
      leftrule=0pt,
      rightrule=0pt,
      fontupper=\color{\ChapterFormatFormalBar@TitleColor}\bfseries\fontsize{\ChapterFormatFormalBar@TitleFontsize}{16pt}\selectfont,
      enlarge left by=-1in-\hoffset-\oddsidemargin, 
      enlarge right by=-\paperwidth+1in+\hoffset+\oddsidemargin+\textwidth,
      width=\paperwidth, 
      left=1in+\hoffset+\oddsidemargin, 
      right=\paperwidth-1in-\hoffset-\oddsidemargin-\textwidth,
      top=\ChapterFormatFormalBar@BanerInner, 
      bottom=\ChapterFormatFormalBar@BanerInner, 
    ]
    #1
    \end{tcolorbox}%
  }
  [\vspace{-25pt}]

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\titlespacing*{\chapter}
{0pt}% left spacing
{0pt}% before spacing
{0pt}% after spacing
%[right]


