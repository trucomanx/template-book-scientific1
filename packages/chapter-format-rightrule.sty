\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chapter-format-rightrule}[2014/10/23 Title chapter package]


\RequirePackage{xcolor}
\RequirePackage{kvoptions} % Carga la biblioteca kvoptions
\RequirePackage[explicit]{titlesec} % necesario para titleformat. [explicit] habilita usar #1
\RequirePackage{lmodern}  % The lmodern package was used just to have access to a 80pt font size.

\makeatletter

% Define las opciones de paquete Width y TextColor
\SetupKeyvalOptions{
  family=ChapterFormatRightRule,
  prefix=ChapterFormatRightRule@
}

\DeclareStringOption[1.5pt]{RuleTickness}
\DeclareStringOption[black]{TitleColor}
\DeclareStringOption[black]{PreTitleColor}
\DeclareStringOption[120]{PreTitleFontsize}
\DeclareStringOption[4cm]{PreTitleWidth}
\DeclareStringOption[black]{RuleColor}

% Procesa las opciones del paquete
\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title with number
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titleformat
{\chapter}%command
[block]%shape
{\normalfont}%format
{}%label
{0pt}%sep
{\parbox[b]{\ChapterFormatRightRule@PreTitleWidth}{\fontsize{\ChapterFormatRightRule@PreTitleFontsize}{0}\color{\ChapterFormatRightRule@PreTitleColor}\selectfont\thechapter}%
 \parbox[b]{\dimexpr\textwidth-\ChapterFormatRightRule@PreTitleWidth\relax}{%
    \color{\ChapterFormatRightRule@TitleColor}
    \raggedleft%
    \hfill{\bfseries\LARGE#1}\\
    \textcolor{\ChapterFormatRightRule@RuleColor}{\rule{\dimexpr\textwidth-\ChapterFormatRightRule@PreTitleWidth\relax}{\ChapterFormatRightRule@RuleTickness}}}%
    \vspace{-0.5ex}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title without number
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\titleformat
{name=\chapter,numberless}%command
[block]%shape
{\normalfont}%format
{}%label
{0pt}%sep
{\parbox[b]{\ChapterFormatRightRule@PreTitleWidth}{\mbox{}}%
 \parbox[b]{\dimexpr\textwidth-\ChapterFormatRightRule@PreTitleWidth\relax}{%
    \color{\ChapterFormatRightRule@TitleColor}
    \raggedleft%
    \hfill{\bfseries\LARGE#1}\\
    \textcolor{\ChapterFormatRightRule@RuleColor}{\rule{\dimexpr\textwidth-\ChapterFormatRightRule@PreTitleWidth\relax}{\ChapterFormatRightRule@RuleTickness}}}%
    \vspace{-0.5ex}
}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% spacing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\titlespacing*{\chapter}
{0pt}% left spacing
{0pt}% before spacing
{0pt}% after spacing
%[right]

