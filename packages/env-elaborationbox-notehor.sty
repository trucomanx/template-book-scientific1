%% source:
%% https://github.com/trucomanx/env-elaborationbox-notehor


\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{env-elaborationbox-notehor}[2022/05/21 Package with macros to the math enviroment]


\RequirePackage[most]{tcolorbox}
\RequirePackage{xcolor}
\RequirePackage[explicit]{titlesec} %% sections
\RequirePackage{titletoc} %% TOC
\RequirePackage{xparse} %%\ExplSyntaxOn
\RequirePackage{calc}%% para restar


\RequirePackage{etoolbox}%%\ifstrempty %%\newbool{myBool}

% Options
%\DeclareOption{red}{\renewcommand{\wordcolour}{sharelatexcolour}}
\DeclareOption*{\PackageWarning{env-elaborationbox-notehor}{The option ‘\CurrentOption’ is current unknown}}
\ProcessOptions\relax


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Macros 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% defining variable
\newlength{\EnvElaborationBoxNotehorThickness}
\setlength{\EnvElaborationBoxNotehorThickness}{1pt}%{0.8mm}

\newbool{EnvElaborationBoxNotehorShowPreTitle}
\setbool{EnvElaborationBoxNotehorShowPreTitle}{true}

%define Show pretitle
\newcommand{\SetEnvElaborationBoxNotehorShowPreTitle}[1]{\setbool{EnvElaborationBoxNotehorShowPreTitle}{#1}}%


%% Define before space
\newcommand{\EnvElaborationBoxNotehorBeforeSpace}{0pt}
\newcommand{\SetEnvElaborationBoxNotehorBeforeSpace}[1]{\renewcommand{\EnvElaborationBoxNotehorBeforeSpace}{#1}}%

%% Define after space
\newcommand{\EnvElaborationBoxNotehorAfterSpace}{0pt}
\newcommand{\SetEnvElaborationBoxNotehorAfterSpace}[1]{\renewcommand{\EnvElaborationBoxNotehorAfterSpace}{#1}}%

%% Define showed name of enviroment
\newcommand{\EnvElaborationBoxNotehorPreTitle}{Elaboration}
\newcommand{\SetEnvElaborationBoxNotehorPreTitle}[1]{\renewcommand{\EnvElaborationBoxNotehorPreTitle}{#1}}%

%% Define the frame color of enviroment
\newcommand{\EnvElaborationBoxNotehorFrameColor}{gray!20}
\newcommand{\SetEnvElaborationBoxNotehorFrameColor}[1]{\renewcommand{\EnvElaborationBoxNotehorFrameColor}{#1}}%

%% Define the backaground body text color
\newcommand{\EnvElaborationBoxNotehorBackColor}{red!2}
\newcommand{\SetEnvElaborationBoxNotehorBackColor}[1]{\renewcommand{\EnvElaborationBoxNotehorBackColor}{#1}}%

%% Define the backaground body text color
\newcommand{\EnvElaborationBoxNotehorGradeColor}{gray!15}%{gray!15}%{green}
\newcommand{\SetEnvElaborationBoxNotehorGradeColor}[1]{\renewcommand{\EnvElaborationBoxNotehorGradeColor}{#1}}%

%% Define the spiral color
\newcommand{\EnvElaborationBoxNotehorSpiralColor}{gray!80}
\newcommand{\SetEnvElaborationBoxNotehorSpiralColor}[1]{\renewcommand{\EnvElaborationBoxNotehorSpiralColor}{#1}}%

%% Define the spiral color
\newcommand{\EnvElaborationBoxNotehorSpiralHoleColor}{gray!60}
\newcommand{\SetEnvElaborationBoxNotehorSpiralHoleColor}[1]{\renewcommand{\EnvElaborationBoxNotehorSpiralHoleColor}{#1}}%

%% Define the spiral color
\newcommand{\EnvElaborationBoxNotehorSpiralNumber}{10}
\newcommand{\SetEnvElaborationBoxNotehorSpiralNumber}[1]{\renewcommand{\EnvElaborationBoxNotehorSpiralNumber}{#1}}%

%% Define The title body color 
\newcommand{\EnvElaborationBoxNotehorTitleColor}{black}
\newcommand{\SetEnvElaborationBoxNotehorTitleColor}[1]{\renewcommand{\EnvElaborationBoxNotehorTitleColor}{#1}}%

%% Define the tile font 
\newcommand{\EnvElaborationBoxNotehorTitleFont}{\bfseries}
\newcommand{\SetEnvElaborationBoxNotehorTitleFont}[1]{\renewcommand{\EnvElaborationBoxNotehorTitleFont}{#1}}%

%% Define Left width
\newcommand{\SetEnvElaborationBoxNotehorThickness}[1]%
{
    \setlength{\EnvElaborationBoxNotehorThickness}{#1}
}%


%% Warning: These variables dont have \Set... method
\newcommand{\EnvElaborationBoxNotehorListingExt}{EnvElaborationBoxNotehorListingExt}
\newcommand{\EnvElaborationBoxNotehorTocEntryFormat}{}
%



%% Crea una macro que capitaliza la primera letra
\ExplSyntaxOn
\NewExpandableDocumentCommand \ElaborationBoxNotehorFirstLetterUppercase { O{} m }
  { \text_titlecase:nn {#1} {#2} }
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Create a new counter that will follow tcolorbox's numbering
%% Create a new counter that will follow tcolorbox's numbering
\newcounter{elaborationboxCounter}[section]
\renewcommand*{\theelaborationboxCounter}{\noexpand\thesection.\noexpand\arabic{elaborationboxCounter}}


\tcbset{%
    StyleEnvElaborationBoxNotehor/.style=%
    {%
        detach title,
        coltitle=\EnvElaborationBoxNotehorTitleColor,
        colbacktitle=\EnvElaborationBoxNotehorBackColor,
        %before upper={\begin{center}\textbf{\tcbtitle}\end{center}},
        enhanced,
        colframe=\EnvElaborationBoxNotehorFrameColor,
        colback=\EnvElaborationBoxNotehorBackColor,
        fonttitle=\EnvElaborationBoxNotehorTitleFont,
        before skip=\EnvElaborationBoxNotehorBeforeSpace,
        after skip=\EnvElaborationBoxNotehorAfterSpace,
        boxrule=\EnvElaborationBoxNotehorThickness,
        top=7mm,
        sharp corners=north,
        enlarge top initially by= 5mm,
        underlay={%
        \begin{tcbclipinterior}%
        \draw[help lines, step=5mm, \EnvElaborationBoxNotehorGradeColor, shift={(interior.north west)}] (interior.south west) grid (interior.north east);
        \end{tcbclipinterior}%
        },
        overlay={
            \foreach \i in {1,...,\EnvElaborationBoxNotehorSpiralNumber}{
                \draw[draw=\EnvElaborationBoxNotehorGradeColor, left color = \EnvElaborationBoxNotehorSpiralHoleColor, right color = \EnvElaborationBoxNotehorSpiralHoleColor, middle color = gray!20] ([yshift=-5 mm, xshift=5mm+((\i-1)/\EnvElaborationBoxNotehorSpiralNumber)*\textwidth]frame.north west) rectangle ++(10pt,10pt);
                \draw[double=\EnvElaborationBoxNotehorSpiralColor, double distance=1pt] ([xshift=6.5mm+((\i-1)/\EnvElaborationBoxNotehorSpiralNumber)*\textwidth]frame.north west) arc (30:360:2pt and 8pt);
                \draw[double=\EnvElaborationBoxNotehorSpiralColor, double distance=1pt] ([xshift=8mm+((\i-1)/\EnvElaborationBoxNotehorSpiralNumber)*\textwidth]frame.north west) arc (30:360:2pt and 8pt);
                }
        },
        title={#1}
    }%
}%



\newtcolorbox[list inside=\EnvElaborationBoxNotehorListingExt,list type=\EnvElaborationBoxNotehorListingExt,auto counter,number within=section]%
{elaborationbox}%
[1][ ]%
{
  StyleEnvElaborationBoxNotehor=#1,
  code={
  \ifdefempty{\tcbtitletext}
  {
    \tcbset{before upper={\addtocounter{elaborationboxCounter}{-1}\refstepcounter{elaborationboxCounter} \refstepcounter{elaborationboxCounter}}}
  }
  {
    \tcbset{before upper={\addtocounter{elaborationboxCounter}{-1}\refstepcounter{elaborationboxCounter} \begin{center} \tcbtitle \end{center}\refstepcounter{elaborationboxCounter}}}
  }
  \ifbool{EnvElaborationBoxNotehorShowPreTitle}
  {
    \tcbset{before title={\textcolor{\EnvElaborationBoxNotehorTitleColor}{\EnvElaborationBoxNotehorTitleFont\EnvElaborationBoxNotehorPreTitle~\thetcbcounter: }}}
  }
  {
    %
  }
  \ifblank{#1}%\ifdefempty{\tcbtitletext}
    {
    \tcbset{list text={\ElaborationBoxNotehorFirstLetterUppercase{\EnvElaborationBoxNotehorPreTitle}  }} %% texto en TOC
    }
    {%% \tcbtitle is the title write by the user
    \tcbset{list text={#1}} %% texto en TOC
    }
  %
  },
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% List of type 
%% Usar con:  \tcblistof[\section*]{\EnvElaborationBoxNotehorListingExt}{Lista de frases}
%%
\titlecontents{\EnvElaborationBoxNotehorListingExt}[2.00cm] %% Indentation %% left
{\EnvElaborationBoxNotehorTocEntryFormat} %% Spacing and font options for sections %% above code
{\contentslabel[{\thecontentslabel}]{1.45cm}} %% Section number %% numbered-entry-format % {\thetcbcounter}%
{} %% numberless-entry-format
{\ \titlerule*[.5pc]{.}\;\color{black}\thecontentspage} %% filler-page-format 
[] %% separator



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\makeatletter
%\newcommand{\ttll@\EnvElaborationBoxNotehorListingExt}{-1000}
%\makeatother
%% To next warning
%% Package titletoc Warning: Unknown TOC type EnvElaborationBoxNotehorListingExt. I'll set it for you with(titletoc)                level -1000. on input line 1.
